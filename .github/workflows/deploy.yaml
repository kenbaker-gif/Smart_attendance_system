name: Deploy to Railway
on:
  push:
    branches: [ fix/admin-panel ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Sync Variables and Deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          # We use the set command with all variables in a single string 
          # to ensure the CLI parses them as one instruction.
          railway variables --set \
            DB_USER="${{ secrets.DB_USER }}" \
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            DB_HOST="${{ secrets.DB_HOST }}" \
            DB_PORT="${{ secrets.DB_PORT }}" \
            DB_NAME="${{ secrets.DB_NAME }}" \
            DB_OPTIONS="${{ secrets.DB_OPTIONS }}" \
            SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
            SUPABASE_KEY="${{ secrets.SUPABASE_KEY }}" \
            SUPABASE_BUCKET="${{ secrets.SUPABASE_BUCKET }}" \
            USE_SUPABASE="${{ secrets.USE_SUPABASE }}" \
            ADMIN_SECRET="${{ secrets.ADMIN_SECRET }}"

          # Trigger the build and deployment
          railway up --detach