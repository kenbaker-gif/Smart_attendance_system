name: Deploy to Railway
on:
  push:
    branches: [ fix/admin-panel ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Move ENV here so it's global for the whole job
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Sync Variables
        run: |
          variables=(
            "DB_USER=${{ secrets.DB_USER }}"
            "DB_PASSWORD=${{ secrets.DB_PASSWORD }}"
            "DB_HOST=${{ secrets.DB_HOST }}"
            "DB_PORT=${{ secrets.DB_PORT }}"
            "DB_NAME=${{ secrets.DB_NAME }}"
            "DB_OPTIONS=${{ secrets.DB_OPTIONS }}"
            "SUPABASE_URL=${{ secrets.SUPABASE_URL }}"
            "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}"
            "SUPABASE_BUCKET=${{ secrets.SUPABASE_BUCKET }}"
            "USE_SUPABASE=${{ secrets.USE_SUPABASE }}"
            "ADMIN_SECRET=${{ secrets.ADMIN_SECRET }}"
          )

          for var in "${variables[@]}"; do
            # This logic strips the value for the log so your secrets stay safe
            key=$(echo $var | cut -d'=' -f1)
            echo "Syncing: $key"
            railway variables --set "$var"
          done

      - name: Deploy
        run: railway up --detach